version: "3.9"

services:
  discovery:
    build:
      context: ./discovery-server
      dockerfile: ../Dockerfile
    container_name: discovery
    restart: on-failure
    networks:
      - main-net
    ports:
      - "8761:8761"
    environment:
      - JAEGER_AGENT_HOST=jaeger-agent

  predicted_dash:
    build:
      context: ./dashboard
      dockerfile: ../Dockerfile
    container_name: dashboard
    restart: on-failure
    networks:
      - main-net
    ports:
      - "8092:8092"
    environment:
      - EUREKA_SERVER=http://discovery:8761/eureka
      - JAEGER_AGENT_HOST=jaeger-agent
      - DB_HOST=ml-db
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=database
    depends_on:
      - discovery
      - ml-db   

  login_logout:
    build:
      context: ./logout
      dockerfile: ../Dockerfile
    container_name: login_logout
    restart: on-failure
    networks:
      - main-net
    ports:
      - "8089:8089"
    environment:
      - EUREKA_SERVER=http://discovery:8761/eureka
      - JAEGER_AGENT_HOST=jaeger-agent
      - DB_HOST=login_logout-db
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=database 
    depends_on:
      - discovery
      - login_logout-db   


  login_logout-db:
    image: postgres
    container_name: login_logout-db 
    restart: on-failure
    networks:
      - main-net
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=database
    ports:
      - "5436:5432"
    # volumes:
    #   - ./logout/db:/docker-entrypoint-initdb.d
      

  comments:
    build:
      context: ./comments
      dockerfile: ../Dockerfile
    container_name: comments
    restart: on-failure
    networks:
      - main-net
    ports:
      - "8087:8087"
    environment:
      - EUREKA_SERVER=http://discovery:8761/eureka
      - JAEGER_AGENT_HOST=jaeger-agent
      - DB_HOST=comments-db
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=database 
    depends_on:
      - discovery
      - comments-db    

  movie-catalog:
    build:
      context: ./movie-catalog-service
      dockerfile: ../Dockerfile
    container_name: movie-catalog
    restart: on-failure
    networks:
      - main-net
    ports:
      - "8082:8082"
    environment:
      - EUREKA_SERVER=http://discovery:8761/eureka
      - JAEGER_AGENT_HOST=jaeger-agent
    depends_on:
      - discovery

  movie-info:
    build:
      context: ./movie-info-service
      dockerfile: ../Dockerfile
    container_name: movie-info
    restart: on-failure
    networks:
      - main-net
    ports:
      - "8081:8081"
    environment:
      - EUREKA_SERVER=http://discovery:8761/eureka
      - JAEGER_AGENT_HOST=jaeger-agent
      - DB_HOST=movie-info-db
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=database
    depends_on:
      - discovery
      - movie-info-db

  ratings-data:
    build:
        context: ./ratings-data-service
        dockerfile: ../Dockerfile
    container_name: ratings-data
    restart: on-failure
    networks:
      - main-net
    ports:
      - "8083:8083"   
    environment:
      - EUREKA_SERVER=http://discovery:8761/eureka
      - JAEGER_AGENT_HOST=jaeger-agent
      - DB_HOST=ratings-data-db
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=database
    depends_on:
      - discovery
      - ratings-data-db
  
  movie-info-db:
    image: postgres:13.3-alpine
    container_name: movie-info-db
    restart: on-failure
    networks:
      - main-net
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=database
    volumes:
      - ./movie-info-service/db:/docker-entrypoint-initdb.d

  ratings-data-db:
    image: postgres:13.3-alpine
    container_name: ratings-data-db
    restart: on-failure
    networks:
      - main-net
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=database
    volumes:
      - ./ratings-data-service/db:/docker-entrypoint-initdb.d
    restart: on-failure

  comments-db:
    image: postgres:13.3-alpine
    container_name: comments-db
    restart: on-failure
    networks:
      - main-net
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=database
    volumes:
      - ./comments/db:/docker-entrypoint-initdb.d

  ml-db:
   image: postgres:13.3-alpine
   container_name: ml-db
   restart: on-failure
   networks:
      - main-net
   environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=database
   ports:
      - "5432:5432"
   volumes:
      - ./dasboard/db:/docker-entrypoint-initdb.d

  pgadmin:
    container_name: pgadmin4_container
    image: dpage/pgadmin4
    restart: always
    networks:
      - main-net
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: root
    ports:
      - "5050:80"
  
  # movie-client:
  #   build: 
  #     context: ./movie-client
  #   container_name: movie-client
  #   restart: on-failure
  #   networks:
  #     - main-net
  #   command: /home/nginx/nginx-init.sh
  #   ports:
  #     - "4200:80"
  #   environment:
  #     # It says URI but don't include the scheme... So the format should be "host:port"
  #     - MOVIE_CATALOG_SERVICE_URI=movie-catalog:8082
  #     - MOVIE_INFO_SERVICE_URI=movie-info:8081
  #     - RATINGS_DATA_SERVICE_URI=ratings-data:8083
  #     - JAEGER_AGENT_URI=jaeger-agent:6831
  #   depends_on:
  #     - movie-catalog
  #     - movie-info
  #     - ratings-data


  
networks:
  main-net:
    driver: bridge
    name: main-net
    
