# # Load the OpenTracing dynamic module.
# # load_module modules/ngx_http_opentracing_module.so;

# user  nginx;
# worker_processes  auto;
# error_log  /var/log/nginx/error.log notice;
# pid        /var/run/nginx.pid;

# events {
#   worker_connections  1024;
# }

# http {

#     # Load a vendor tracer
#     # opentracing_load_tracer /usr/local/lib/libjaegertracing_plugin.so /etc/nginx-jaeger-config.json;

#     # Enable tracing for all requests.
#     # opentracing on;

#     include       /etc/nginx/mime.types;
#     default_type  application/octet-stream;

#     log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
#                       '$status $body_bytes_sent "$http_referer" '
#                       '"$http_user_agent" "$http_x_forwarded_for"';

#     access_log  /var/log/nginx/access.log  main;
#     sendfile        on;
#     keepalive_timeout  65;
#     include /etc/nginx/conf.d/*.conf;

#     # upstream movie_catalog_service {
#     #     server localhost:8082;
#     # }

#     # upstream movie_info_service {
#     #     server localhost:8081;
#     # }

#     # upstream ratings_data_service {
#     #     server localhost:8083;
#     # }

#     # upstream comments_service {
#     #     server localhost:8087;
#     # }

#     server {
#         listen 80;

#          location /api/catalog {
#             # opentracing_operation_name $uri;
#             # opentracing_propagate_context;
#             # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             # proxy_set_header Host $host;
#             # proxy_redirect off;
#                 rewrite ^/api(/.*) $1 break;
#                 # proxy_redirect off;
#                 proxy_pass http://localhost:8082;
#                 proxy_set_header Host $host;


#         }

#         # location /api {
#         #     # opentracing_operation_name $uri;
#         #     # opentracing_propagate_context;
#         #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         #     # proxy_set_header Host $host;
#         #     proxy_redirect off;

#         #     location /api/catalog  {
#         #         rewrite ^/api(/.*) $1 break;
#         #         proxy_redirect off;
#         #         proxy_set_header Host $host;
#         #         proxy_pass http://localhost:8082;
#         #     }

#         #     location /api/movies {
#         #         rewrite ^/api(/.*) $1 break;
#         #         proxy_pass http://localhost:8081;
#         #     }

#         #     location /api/ratings {
#         #         rewrite ^/api(/.*) $1 break;
#         #         proxy_pass http://localhost:8083;
#         #     }

#         #     location /api/comments {
#         #         rewrite ^/api(/.*) $1 break;
#         #         proxy_pass http://localhost:8087;
#         #     }
#         # }


#         # location / {
#         #     opentracing_operation_name $uri;
#         #     root /usr/share/nginx/html;
#         #     index index.html index.htm;
#         #     try_files $uri $uri/ /index.html  =404;
#         #     gzip on;
#         # }

#     }
# }


server {
  listen 80;
  sendfile on;
  default_type application/octet-stream;

  gzip on;
  gzip_http_version 1.1;
  gzip_disable      "MSIE [1-6]\.";
  gzip_min_length   256;
  gzip_vary         on;
  gzip_proxied      expired no-cache no-store private auth;
  gzip_types        text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_comp_level   9;

  root /usr/share/nginx/html;

  location / {
      try_files $uri $uri/ /index.html =404;
  }
   location /api/ {
    #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #    proxy_set_header Host $host;
    #    proxy_redirect off;
       location /api/catalog/  {
           rewrite ^/api(/.*)$ http://movie-catalog-micro.lad-poc.svc.cluster.local:8080$1 redirect;
           }
       location /api/movies/  {
           rewrite ^/api(/.*)$ http://movie-info-micro.lad-poc.svc.cluster.local:8080$1 redirect;
           }
       location /api/ratings/  {
           rewrite ^/api(/.*)$ http://ratings-micro.lad-poc.svc.cluster.local:8080$1 redirect;
           }
        location /api/comments/  {
           rewrite ^/api(/.*)$ http://comments.lad-poc.svc.cluster.local:8080$1 redirect;
           }
   }
}
